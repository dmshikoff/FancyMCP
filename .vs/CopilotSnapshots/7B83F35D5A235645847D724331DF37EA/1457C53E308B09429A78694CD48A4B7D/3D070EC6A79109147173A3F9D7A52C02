using System.ComponentModel;
using System.Text.Json;
using ModelContextProtocol.Server;
using Microsoft.Extensions.DependencyInjection;

namespace FancyMCP;

[McpServerToolType]
public class MtgTools
{
    private static IServiceProvider? _serviceProvider;

    public static void SetServiceProvider(IServiceProvider serviceProvider)
    {
        _serviceProvider = serviceProvider;
    }

    [McpServerTool, Description("Get a list of cards by search parameters")]
    public static async Task<string> GetMtgCards(string message)
    {
        if (_serviceProvider == null)
        {
            return "Error: Service provider not initialized";
        }

        using (var scope = _serviceProvider.CreateScope())
        {
            var mtgAiService = scope.ServiceProvider.GetService(typeof(IMtgAiService)) as IMtgAiService;
            if (mtgAiService == null)
            {
                return "Error: Could not resolve IMtgAiService";
            }

            var cards = await mtgAiService.UseDeckAiService(message);
            
            return cards != null ? JsonSerializer.Serialize(cards) : "No cards found";
        }
    }
}
