using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;
using ModelContextProtocol.Server;
using System.ComponentModel;
using FancyMCP;
using Azure;
using Azure.AI.OpenAI;
using MtgChatBotPrototype.Services;
using Microsoft.Extensions.Configuration;

// Add global exception handler
AppDomain.CurrentDomain.UnhandledException += (sender, e) =>
{
    var exception = e.ExceptionObject as Exception;
    Console.Error.WriteLine("=== UNHANDLED EXCEPTION ===");
    Console.Error.WriteLine($"Exception Type: {exception?.GetType().FullName}");
    Console.Error.WriteLine($"Message: {exception?.Message}");
    Console.Error.WriteLine($"Stack Trace: {exception?.StackTrace}");
    
    if (exception?.InnerException != null)
    {
        Console.Error.WriteLine($"\n=== INNER EXCEPTION ===");
        Console.Error.WriteLine($"Inner Exception Type: {exception.InnerException.GetType().FullName}");
        Console.Error.WriteLine($"Inner Message: {exception.InnerException.Message}");
        Console.Error.WriteLine($"Inner Stack Trace: {exception.InnerException.StackTrace}");
    }
    
    Console.Error.WriteLine("=== END EXCEPTION ===");
};

var builder = Host.CreateApplicationBuilder(args);
builder.Logging.AddConsole(consoleLogOptions =>
{
    // Configure all logs to go to stderr
    consoleLogOptions.LogToStandardErrorThreshold = LogLevel.Trace;
});

// Get configuration values
string? azureOpenAiUrl = builder.Configuration["AzureOpenAI:Endpoint"];
string? azureOpenAiKey = builder.Configuration["AzureOpenAI:ApiKey"];

if(string.IsNullOrEmpty(azureOpenAiKey) || string.IsNullOrEmpty(azureOpenAiUrl))
{
    throw new Exception("invalid OpenAI Key or URI");
}

// Register Azure OpenAI client as transient factory instead of singleton instance
builder.Services.AddTransient<AzureOpenAIClient>(_ => new AzureOpenAIClient(
    new Uri(azureOpenAiUrl),
    new AzureKeyCredential(azureOpenAiKey)
));

// Register HTTP clients and services
builder.Services.AddHttpClient();
builder.Services.AddTransient<IMtgApiClient, MtgApiClient>(sp => 
{
    var httpClientFactory = sp.GetRequiredService<IHttpClientFactory>();
    var httpClient = httpClientFactory.CreateClient();
    return new MtgApiClient(httpClient);
});
builder.Services.AddTransient<IDeckAiService, DeckAiService>(sp =>
{
    var azureClient = sp.GetRequiredService<AzureOpenAIClient>();
    var mtgClient = sp.GetRequiredService<IMtgApiClient>();
    var config = builder.Configuration;
    return new DeckAiService(azureClient, mtgClient, config);
});
builder.Services.AddTransient<IMtgAiService, MtgAiService>();

// Register MCP server AFTER all other services
builder.Services
    .AddMcpServer()
    .WithStdioServerTransport()
    .WithToolsFromAssembly();

var app = builder.Build();

// Set the service provider for the tools to use
MtgTools.SetServiceProvider(app.Services);

await app.RunAsync();

